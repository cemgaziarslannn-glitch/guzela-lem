<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>G√ºzel Ailem</title>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #ffb6c1, #ff66b2);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* Profil ekranƒ± */
  #profileSetup {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    color: white;
    padding: 20px;
    text-align: center;
  }
  #profileSetup input {
    margin: 5px;
    padding: 12px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    outline: none;
    width: 80%;
    text-align: center;
  }
  #profileSetup button {
    margin-top: 10px;
    padding: 12px 20px;
    border-radius: 25px;
    border: none;
    background: white;
    color: #ff66b2;
    font-size: 16px;
    cursor: pointer;
    font-weight: bold;
  }
  #avatarPicker {
    margin-top: 10px;
  }
  .avatarBtn {
    font-size: 28px;
    cursor: pointer;
    margin: 5px;
    background: none;
    border: none;
  }

  /* Chat alanƒ± */
  #chatContainer {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .message {
    display: inline-block;
    padding: 10px 14px;
    border-radius: 18px;
    max-width: 75%;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in-out;
  }

  .my-message {
    align-self: flex-end;
    background: rgba(255,255,255,0.9);
    color: #ff3399;
    border-bottom-right-radius: 4px;
  }

  .other-message {
    align-self: flex-start;
    background: rgba(255,255,255,0.7);
    color: #333;
    border-bottom-left-radius: 4px;
  }

  .username {
    font-weight: bold;
    font-size: 13px;
    display: block;
    margin-bottom: 3px;
  }

  /* Mesaj yazƒ±yor g√∂stergesi */
  #typingIndicator {
    font-size: 13px;
    color: white;
    text-align: center;
    padding: 4px 0;
    min-height: 18px;
  }

  /* Mesaj giri≈ü alanƒ± */
  #messageInput {
    display: flex;
    gap: 5px;
    background: rgba(255,255,255,0.85);
    padding: 8px;
    align-items: center;
  }
  #messageText {
    flex: 1;
    padding: 10px;
    border-radius: 20px;
    border: none;
    font-size: 15px;
    outline: none;
  }
  #sendBtn {
    background: #ff3399;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    font-size: 18px;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(5px);}
    to {opacity: 1; transform: translateY(0);}
  }
</style>
</head>
<body>

<div id="profileSetup">
  <h3>Profilini Olu≈ütur</h3>
  <input type="text" id="profileNameInput" placeholder="Kullanƒ±cƒ± Adƒ±">
  <div id="avatarPicker">
    Avatar se√ß: 
    <button class="avatarBtn">üòÉ</button>
    <button class="avatarBtn">üòé</button>
    <button class="avatarBtn">üòç</button>
    <button class="avatarBtn">ü§ó</button>
  </div>
  <button id="saveProfileBtn">Kaydet ve Sohbete Ba≈üla</button>
</div>

<div id="chatContainer" style="display:none;"></div>
<div id="typingIndicator"></div>

<div id="messageInput" style="display:none;">
  <input type="text" id="messageText" placeholder="Mesajƒ±nƒ± yaz..." />
  <button id="sendBtn">‚û§</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444",
  measurementId: "G-3CH1J0DLGZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const profileSetupDiv = document.getElementById('profileSetup');
const profileNameInput = document.getElementById('profileNameInput');
const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');
const avatarButtons = document.querySelectorAll('.avatarBtn');
const messageInputDiv = document.getElementById('messageInput');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const typingIndicator = document.getElementById('typingIndicator');

const colors = ['#ffb6c1','#ff99cc','#ffc0cb','#ff66b2','#ff3399','#ff0066'];

let userColor, userAvatar="üòÉ", username, userID, typingTimeout;

if(localStorage.getItem('chatUserID')){
  userID = localStorage.getItem('chatUserID');
  get(child(ref(db), `users/${userID}`)).then(snapshot=>{
    if(snapshot.exists()){
      const data = snapshot.val();
      username = data.username;
      userAvatar = data.avatar || "üòÉ";
      userColor = data.color || colors[Math.floor(Math.random()*colors.length)];
      startChat();
    } else {
      showProfileSetup();
    }
  });
} else {
  showProfileSetup();
}

function showProfileSetup(){
  profileSetupDiv.style.display = "flex";
  userColor = colors[Math.floor(Math.random()*colors.length)];
}

avatarButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    userAvatar = btn.textContent;
  });
});

saveProfileBtn.addEventListener('click', ()=>{
  username = profileNameInput.value.trim() || "√úye" + Math.floor(Math.random()*1000);
  const newUserRef = push(ref(db, 'users'));
  userID = newUserRef.key;
  localStorage.setItem('chatUserID', userID);
  set(ref(db, `users/${userID}`), { username, avatar: userAvatar, color: userColor });
  startChat();
});

function startChat(){
  profileSetupDiv.style.display = "none";
  chatContainer.style.display = "flex";
  messageInputDiv.style.display = "flex";

  // Yazƒ±yor g√∂stergesi
  messageInput.addEventListener('input', ()=>{
    set(ref(db, `typing/${userID}`), username + ' yazƒ±yor...');
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>{ set(ref(db, `typing/${userID}`), ''); }, 1500);
  });

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });

  onChildAdded(ref(db, 'messages'), (snapshot)=>{
    const msg = snapshot.val();
    renderMessage(msg);
  });

  // Diƒüer kullanƒ±cƒ±lar yazƒ±yor g√∂stergesi
  const typingRef = ref(db, 'typing');
  onValue(typingRef, (snapshot)=>{
    const data = snapshot.val() || {};
    let displayText = '';
    for(const key in data){
      if(key !== userID && data[key]){
        displayText = data[key];
        break;
      }
    }
    typingIndicator.textContent = displayText;
  });
}

function sendMessage(){
  const text = messageInput.value.trim();
  if(text){
    push(ref(db, 'messages'), { user: username, text, color: userColor, avatar: userAvatar, uid: userID, timestamp: Date.now() });
    messageInput.value='';
    set(ref(db, `typing/${userID}`), '');
  }
}

function renderMessage(msg){
  const div = document.createElement('div');
  div.classList.add('message');
  if(msg.uid === userID){
    div.classList.add('my-message');
  } else {
    div.classList.add('other-message');
  }
  div.innerHTML = `<span class="username">${msg.avatar} ${msg.user}</span>${msg.text}`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}
</script>

</body>
</html>

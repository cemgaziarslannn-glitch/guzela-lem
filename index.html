<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Güzel Ailem - WhatsApp Tarzı Chat</title>
<style>
body { margin:0; font-family:'Segoe UI', sans-serif; height:100vh; display:flex; background:#f0f0f0; }
#userList { width:30%; max-width:250px; background:#fff; border-right:1px solid #ddd; overflow-y:auto; display:flex; flex-direction:column; }
#userList h3 { text-align:center; padding:10px; margin:0; background:#ff66b2; color:white; }
.userBtn { padding:10px 15px; border:none; background:none; text-align:left; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid #eee; position:relative; }
.userBtn:hover { background:#ffe6f0; }
.userBtn.active { background:#ffb6c1; color:white; }
.unreadBadge { position:absolute; top:5px; right:10px; background:#ff3399; color:white; font-size:12px; font-weight:bold; padding:2px 6px; border-radius:12px; display:none; }
#chatPanel { flex:1; display:flex; flex-direction:column; position: relative; }
#chatHeader { background:#ff66b2; color:white; padding:12px 15px; font-weight:bold; display:flex; align-items:center; gap:10px; }
#chatContainer { flex:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column; gap:8px; background:#f5f5f5; }
.message { display:inline-block; padding:10px 14px; border-radius:18px; max-width:75%; word-wrap:break-word; animation:fadeIn 0.3s ease-in-out; }
.my-message { align-self:flex-end; background:#ffb6c1; color:white; border-bottom-right-radius:4px; }
.other-message { align-self:flex-start; background:#fff; color:#333; border-bottom-left-radius:4px; }
.username { font-weight:bold; font-size:13px; display:block; margin-bottom:3px; }
#messageInput { display:flex; gap:5px; padding:8px; border-top:1px solid #ddd; background:#fff; }
#messageInput input { flex:1; padding:8px; border-radius:20px; border:1px solid #ccc; font-size:14px; outline:none; }
#sendBtn { background:#ff3399; color:white; border:none; border-radius:50%; width:45px; height:45px; font-size:18px; cursor:pointer; }
#typingText { font-size:13px; color:#555; padding-left:10px; }
@keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }
#profileSetup { position:absolute; top:0; left:0; width:100%; height:100%; background:linear-gradient(135deg,#ffb6c1,#ff66b2); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; }
#profileSetup input { margin:5px; padding:12px; font-size:16px; border-radius:25px; border:none; outline:none; width:80%; text-align:center; }
#profileSetup button { margin-top:10px; padding:12px 20px; border-radius:25px; border:none; background:white; color:#ff66b2; font-size:16px; cursor:pointer; font-weight:bold; }
#avatarPicker { margin-top:10px; }
.avatarBtn { font-size:28px; cursor:pointer; margin:5px; background:none; border:none; }
#adminPanel { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:flex-start; z-index:20; color:white; overflow-y:auto; padding:20px; }
#adminPanel h2 { margin-bottom:15px; }
#adminPanel button { margin:5px; padding:10px 15px; border:none; border-radius:10px; cursor:pointer; }
#blockNotice { display:none; background:#ff3b30; color:#fff; padding:8px 12px; font-size:13px; }
#blockBtn { margin-left:auto; padding:6px 10px; border:none; border-radius:8px; background:#ff3399; color:white; cursor:pointer; font-size:13px; }
#blockBtn.unblock { background:#555; }
.admin-section { border:1px solid #ff66b2; padding:10px; margin:10px 0; border-radius:12px; width:100%; max-width:500px; background:rgba(255,255,255,0.05); }
</style>
</head>
<body>

<div id="profileSetup">
  <h3>Profilini Oluştur</h3>
  <input type="text" id="profileNameInput" placeholder="Kullanıcı Adı">
  <div id="avatarPicker">
    Avatar seç: 
    <button class="avatarBtn">😃</button>
    <button class="avatarBtn">😎</button>
    <button class="avatarBtn">😍</button>
    <button class="avatarBtn">🤗</button>
  </div>
  <button id="saveProfileBtn">Kaydet ve Sohbete Başla</button>
</div>

<div id="userList">
  <h3>Kullanıcılar</h3>
</div>

<div id="chatPanel">
  <div id="chatHeader">
    <span id="chatTitle">Sohbet Seçiniz</span>
  </div>
  <div id="blockNotice">Bu kullanıcı tarafından engellendiniz.</div>
  <div id="chatContainer"></div>
  <div id="typingText"></div>
  <div id="messageInput">
    <input type="text" id="messageText" placeholder="Mesajınızı yazın..." />
    <button id="sendBtn">➤</button>
  </div>
</div>

<div id="adminPanel">
  <h2>⚡ Mega Admin Paneli ⚡</h2>
  <div class="admin-section">
    <h3>Kullanıcı Kontrolü</h3>
    <div id="adminUserList"></div>
  </div>
  <div class="admin-section">
    <h3>Global Kontroller</h3>
    <button id="globalMute">Tüm Kullanıcıları Sessize Al</button>
    <button id="globalUnmute">Tüm Kullanıcıları Serbest Bırak</button>
    <button id="clearAllChats">Tüm Sohbetleri Temizle</button>
    <button id="themeToggle">Tema Değiştir</button>
  </div>
  <div class="admin-section">
    <h3>Veri Yönetimi</h3>
    <button id="backupData">Veri Yedeği Al</button>
    <button id="restoreData">Yedeği Geri Yükle</button>
  </div>
  <button id="closeAdmin">Admin Panelini Kapat</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, push, set, get, onChildAdded, onValue, off, remove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444",
  measurementId: "G-3CH1J0DLGZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let userColor, userAvatar="😃", username, userID, typingTimeout;
let currentChatUserID = null;
const tickSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2574/2574-preview.mp3");
let mutedUsers = {};
let chatRef = null;
let typingRef = null;
let unreadCounts = {};
let userButtons = {};
let myBlocked = {};

const profileSetupDiv = document.getElementById('profileSetup');
const profileNameInput = document.getElementById('profileNameInput');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const avatarButtons = document.querySelectorAll('.avatarBtn');
const userListDiv = document.getElementById('userList');
const chatHeader = document.getElementById('chatHeader');
const chatTitle = document.getElementById('chatTitle');
const chatContainer = document.getElementById('chatContainer');
const messageInput = document.getElementById('messageText');
const sendBtn = document.getElementById('sendBtn');
const typingText = document.getElementById('typingText');
const adminPanel = document.getElementById('adminPanel');
const adminUserList = document.getElementById('adminUserList');
const blockNotice = document.getElementById('blockNotice');

const colors = ['#ffb6c1','#ff99cc','#ffc0cb','#ff66b2','#ff3399','#ff0066'];

function showProfile(){ profileSetupDiv.style.display="flex"; userColor = colors[Math.floor(Math.random()*colors.length)]; }
function showChatUI(){ profileSetupDiv.style.display="none"; loadUserList(); subscribeMyBlocked(); }

if(localStorage.getItem('chatUserID')){
  userID = localStorage.getItem('chatUserID');
  get(ref(db,`users/${userID}`)).then(snap=>{
    if(snap.exists()){
      const data = snap.val();
      username = data.username;
      userAvatar = data.avatar||"😃";
      userColor = data.color||colors[Math.floor(Math.random()*colors.length)];
      showChatUI();
    } else showProfile();
  });
} else showProfile();

avatarButtons.forEach(btn=>{ btn.addEventListener('click', ()=>{ userAvatar = btn.textContent; }); });
saveProfileBtn.addEventListener('click', ()=>{ 
  username = profileNameInput.value.trim()||"Üye"+Math.floor(Math.random()*1000);
  const newUserRef = push(ref(db,'users'));
  userID = newUserRef.key;
  localStorage.setItem('chatUserID', userID);
  set(ref(db, `users/${userID}`), { username, avatar:userAvatar, color:userColor });
  showChatUI();
});

// ---------- Engelleme ---------- //
function subscribeMyBlocked(){
  const r = ref(db, `users/${userID}/blockedUsers`);
  onValue(r, snap=>{ myBlocked = snap.val() || {}; refreshBlockButton(); });
}

// ---------- Kullanıcı Listesi ---------- //
function loadUserList(){
  onValue(ref(db,'users'), snap=>{
    const users = snap.val()||{};
    userListDiv.innerHTML='<h3>Kullanıcılar</h3>';
    userButtons = {};
    adminUserList.innerHTML='';
    Object.keys(users).forEach(uid=>{
      if(uid!==userID){
        const btn = document.createElement('button');
        btn.className='userBtn';
        btn.textContent = users[uid].avatar+' '+users[uid].username;
        btn.dataset.uid = uid;

        const badge = document.createElement('span');
        badge.className='unreadBadge';
        btn.appendChild(badge);
        unreadCounts[uid] = unreadCounts[uid] || 0;
        userButtons[uid] = btn;

        btn.onclick = ()=> selectChatUser(uid, users[uid], btn);
        userListDiv.appendChild(btn);

        // --- Admin Panel İçin Kullanıcı Listeleme ---
        const adminDiv = document.createElement('div');
        adminDiv.textContent = users[uid].avatar+' '+users[uid].username;
        const muteBtn = document.createElement('button'); muteBtn.textContent='Sessize Al';
        muteBtn.onclick = ()=>{ mutedUsers[uid]=true; alert('Kullanıcı sessize alındı!'); };
        const unmuteBtn = document.createElement('button'); unmuteBtn.textContent='Sessizi Kaldır';
        unmuteBtn.onclick = ()=>{ delete mutedUsers[uid]; alert('Kullanıcı serbest bırakıldı!'); };
        const banBtn = document.createElement('button'); banBtn.textContent='Banla';
        banBtn.onclick = ()=>{ remove(ref(db, `users/${uid}`)); alert('Kullanıcı banlandı!'); };
        const msgClearBtn = document.createElement('button'); msgClearBtn.textContent='Mesajları Sil';
        msgClearBtn.onclick = ()=>{ remove(ref(db, `privateMessages/${userID}/${uid}`)); remove(ref(db, `privateMessages/${uid}/${userID}`)); alert('Mesajlar silindi!'); };
        adminDiv.appendChild(muteBtn); adminDiv.appendChild(unmuteBtn); adminDiv.appendChild(banBtn); adminDiv.appendChild(msgClearBtn);
        adminUserList.appendChild(adminDiv);
      }
    });
    listenForUnread(users);
  });
}

// ---------- Admin Global Kontroller ----------
document.getElementById('globalMute').onclick = ()=>{ 
  Object.keys(userButtons).forEach(uid=>{ mutedUsers[uid]=true; }); 
  alert('Tüm kullanıcılar sessize alındı!');
};
document.getElementById('globalUnmute').onclick = ()=>{ mutedUsers={}; alert('Tüm kullanıcılar serbest bırakıldı!'); };
document.getElementById('clearAllChats').onclick = ()=>{
  Object.keys(userButtons).forEach(uid=>{
    remove(ref(db,`privateMessages/${userID}/${uid}`));
    remove(ref(db,`privateMessages/${uid}/${userID}`));
  });
  chatContainer.innerHTML='';
  alert('Tüm sohbetler silindi!');
};
document.getElementById('themeToggle').onclick = ()=>{
  document.body.style.background = document.body.style.background.includes('linear-gradient') ? '#f0f0f0' : 'linear-gradient(135deg,#ffb6c1,#ff66b2)';
};

// ---------- Admin Panel Aç/Kapa ----------
document.addEventListener('keydown', e=>{ if(e.ctrlKey && e.key==='3'){ adminPanel.style.display='flex'; } });
document.getElementById('closeAdmin').onclick = ()=> adminPanel.style.display='none';

// ---------- Mesaj Gönderme ----------
function sendMessage(){
  const text = messageInput.value.trim();
  if(!text || !currentChatUserID) return;
  if(mutedUsers[currentChatUserID]){ alert("Bu kullanıcı sessize alınmış!"); return; }
  if (myBlocked && myBlocked[currentChatUserID]) { alert("Bu kişiyi engellemişsiniz."); return; }
  get(ref(db, `users/${currentChatUserID}/blockedUsers/${userID}`)).then(snap=>{
    if(snap.exists()){ blockNotice.style.display='block'; return; } else { blockNotice.style.display='none'; }
    const msgData = { user:username, text, avatar:userAvatar, color:userColor, uid:userID, timestamp:Date.now() };
    push(ref(db,`privateMessages/${userID}/${currentChatUserID}`),msgData);
    push(ref(db,`privateMessages/${currentChatUserID}/${userID}`),msgData);
    messageInput.value='';
    set(ref(db,`typing/${userID}_${currentChatUserID}`),'');
  });
}
messageInput.addEventListener('input', ()=>{
  if(!currentChatUserID) return;
  set(ref(db,`typing/${userID}_${currentChatUserID}`), username+' yazıyor...');
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{ set(ref(db,`typing/${userID}_${currentChatUserID}`),''); },1500);
});
messageInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });
sendBtn.addEventListener('click', sendMessage);

// ---------- Mesajları Yükle ----------
function loadMessages(uid){
  if(chatRef) off(chatRef);
  if(typingRef) off(typingRef);
  chatContainer.innerHTML='';
  chatRef = ref(db, `privateMessages/${userID}/${uid}`);
  typingRef = ref(db,'typing');
  onChildAdded(chatRef, snap => {
    const msg = snap.val();
    if (msg.uid !== userID && myBlocked && myBlocked[msg.uid]) return;
    renderMessage(msg);
    tickSound.play().catch(()=>{});
    chatContainer.scrollTop = chatContainer.scrollHeight;
  });
  onValue(typingRef, snap=>{ const data = snap.val()||{}; typingText.textContent = data[`${uid}_${userID}`]||''; });
}
function renderMessage(msg){
  const div = document.createElement('div');
  div.classList.add('message');
  if(msg.uid===userID) div.classList.add('my-message'); else div.classList.add('other-message');
  div.innerHTML = `<span class="username">${msg.avatar} ${msg.user}</span>${msg.text}`;
  chatContainer.appendChild(div);
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

// ---------- Engelleme Butonu ----------
function selectChatUser(uid,userData,btn){
  currentChatUserID = uid;
  chatTitle.textContent = `${userData.avatar} ${userData.username}`;
  Array.from(userListDiv.querySelectorAll('.userBtn')).forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  unreadCounts[uid]=0; updateBadge(uid);
  loadMessages(uid); ensureBlockButton(); hideBlockNotice();
}
function ensureBlockButton(){
  let blockBtn = document.getElementById('blockBtn');
  if(!blockBtn){
    blockBtn = document.createElement('button');
    blockBtn.id = 'blockBtn';
    blockBtn.addEventListener('click', toggleBlockCurrent);
    chatHeader.appendChild(blockBtn);
  }
  refreshBlockButton();
}
function refreshBlockButton(){
  const blockBtn = document.getElementById('blockBtn');
  if(!blockBtn) return;
  if(!currentChatUserID) { blockBtn.style.display='none'; return; }
  blockBtn.style.display='inline-block';
  const isBlocked = !!(myBlocked && myBlocked[currentChatUserID]);
  blockBtn.textContent = isBlocked ? 'Engeli Kaldır' : 'Engelle';
  blockBtn.classList.toggle('unblock', isBlocked);
}
async function toggleBlockCurrent(){
  if(!currentChatUserID) return;
  const path = `users/${userID}/blockedUsers/${currentChatUserID}`;
  const isBlocked = !!(myBlocked && myBlocked[currentChatUserID]);
  if(isBlocked){ await remove(ref(db, path)); } else { await set(ref(db, path), true); }
}

// ---------- Badge Güncelle ----------
function listenForUnread(users){
  Object.keys(users).forEach(uid=>{
    if(uid===userID) return;
    const chatPath = `privateMessages/${uid}/${userID}`;
    const chatRefLocal = ref(db, chatPath);
    onChildAdded(chatRefLocal, snap=>{
      const msg = snap.val();
      if (myBlocked && myBlocked[uid]) return;
      if(currentChatUserID !== uid){ unreadCounts[uid]=(unreadCounts[uid]||0)+1; updateBadge(uid); }
    });
  });
}
function updateBadge(uid){
  const btn = userButtons[uid]; if(!btn) return;
  const badge = btn.querySelector('.unreadBadge');
  if(unreadCounts[uid]>0){ badge.style.display='inline'; badge.textContent = unreadCounts[uid]; } else badge.style.display='none';
}
function hideBlockNotice(){ blockNotice.style.display='none'; }
</script>
</body>
</html>
